name: api-gateway ci

on:
   push:
      branches: [ "main" ]
      paths:
         - "api-gateway/**"
         - ".github/workflows/actions/action.yaml"
         - ".github/workflows/api-gateway-ci.yaml"
         - "pom.xml"
   pull_request:
      branches: [ "main" ]
      paths:
         - "api-gateway/**"
         - ".github/workflows/actions/action.yaml"
         - ".github/workflows/api-gateway-ci.yaml"
         - "pom.xml"
   workflow_dispatch:

jobs:
   Build:
      runs-on: ubuntu-latest
      env:
         FROM_ORIGINAL_REPOSITORY: ${{ github.event.pull_request.head.repo.full_name == github.repository || github.ref == 'refs/heads/main' }}
      steps:
         -  uses: actions/checkout@v4
            with:
               fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
         -  uses: ./.github/workflows/actions
         -  name: Run Maven Build Command
            run: mvn clean install -pl api-gateway -am -DskipTests
         -  name: Log in to the Container registry
            if: ${{ github.ref == 'refs/heads/main' }}
            uses: docker/login-action@v3
            with:
               registry: ghcr.io
               username: ${{ github.actor }}
               password: ${{ secrets.PAT_TOKEN }}
         -  name: Build and push Docker images
            if: ${{ github.ref == 'refs/heads/main' }}
            uses: docker/build-push-action@v6
            with:
               context: ./api-gateway
               push: true
               tags: ghcr.io/hiepthanhtran/hscm-api-gateway:latest